# Production Deployment Guide

Руководство по развертыванию Pravda Market в production.

## Перед deployment

### 1. Убедитесь что все тесты проходят

```bash
# Backend
cd backend
pytest -v

# Frontend
cd frontend
npm test -- --run

# Smoke tests
cd backend
pytest -m smoke -v
```

Ожидаемый результат: **165/165 tests passing (100%)**

---

## Deployment на Railway

### 1. Подготовка

1. Создайте аккаунт на [Railway.app](https://railway.app)
2. Установите Railway CLI:
   ```bash
   npm install -g @railway/cli
   ```
3. Login:
   ```bash
   railway login
   ```

### 2. Создание проекта

```bash
cd backend
railway init
```

### 3. Настройка environment variables

В Railway dashboard (или через CLI):

```bash
# Database (Railway automatically provides PostgreSQL)
DATABASE_URL=postgresql://...  # Auto-generated by Railway

# Security
TELEGRAM_BOT_TOKEN=your_bot_token
ADMIN_TOKEN=$(python -c "import secrets; print(secrets.token_urlsafe(32))")

# CORS
CORS_ORIGINS=["https://your-frontend.com"]

# Environment
ENVIRONMENT=production
DEBUG=false
LOG_LEVEL=INFO
```

### 4. Database Migration

```bash
# Run migrations before first deployment
railway run alembic upgrade head
```

### 5. Deploy

```bash
railway up
```

Или настройте автоматический deploy через GitHub:
- Railway Dashboard → Settings → GitHub → Connect Repository
- Выберите branch (master/main)
- Railway автоматически задеплоит при каждом push

---

## GitHub Actions Deployment

### Настройка

1. Получите Railway token:
   ```bash
   railway tokens create
   ```

2. Добавьте token в GitHub Secrets:
   - Repository → Settings → Secrets and variables → Actions
   - New repository secret:
     - Name: `RAILWAY_TOKEN`
     - Value: (токен из п.1)

3. Push в master/main ветку запустит автоматический deployment

---

## Production Checklist

### Security
- [ ] Сгенерированы новые секреты (TELEGRAM_BOT_TOKEN, ADMIN_TOKEN)
- [ ] CORS настроен только для production domains
- [ ] DEBUG=false
- [ ] Database credentials безопасны (используйте Railway secrets)
- [ ] HTTPS enabled (Railway предоставляет автоматически)

### Database
- [ ] PostgreSQL настроен (Railway auto-provisions)
- [ ] Migrations запущены: `alembic upgrade head`
- [ ] Backup strategy настроена
- [ ] Connection pooling настроен (default: 20 connections)

### Monitoring
- [ ] Health check endpoint работает: `/health/ready`
- [ ] Logs настроены (LOG_FORMAT=json)
- [ ] Sentry для error tracking (опционально)
- [ ] Rate limiting enabled

### Performance
- [ ] Database indexes настроены (auto-created via Alembic)
- [ ] Row-level locking работает
- [ ] Ledger invariant проверяется

---

## Health Checks

Проверьте работоспособность после deployment:

```bash
# Basic health
curl https://your-app.railway.app/

# Detailed health check
curl https://your-app.railway.app/health/ready

# Markets endpoint
curl https://your-app.railway.app/markets

# Expected responses:
# / → {"message": "Pravda Market API", "version": "1.0.0"}
# /health/ready → {"status": "healthy", "database": "connected"}
# /markets → [...]
```

---

## Rollback Plan

Если что-то пошло не так:

### Railway
```bash
# Откатиться на предыдущую версию
railway rollback
```

### Database
```bash
# Откатить migration
railway run alembic downgrade -1
```

### GitHub Actions
- Revert commit в master/main
- Push триггерит автоматический re-deploy

---

## Мониторинг

### Railway Dashboard
- Metrics: CPU, Memory, Network
- Logs: Real-time application logs
- Deployments: История всех deployments

### Application Logs
```bash
# View logs
railway logs

# Follow logs (real-time)
railway logs --follow
```

### Database Monitoring
```bash
# PostgreSQL stats
railway run psql -c "SELECT * FROM pg_stat_database WHERE datname='railway';"
```

---

## Troubleshooting

### Deployment fails
1. Check Railway logs: `railway logs`
2. Verify environment variables
3. Check database connection
4. Ensure migrations ran successfully

### Database issues
```bash
# Connect to database
railway run psql

# Check tables
\dt

# Check migrations
SELECT * FROM alembic_version;
```

### Performance issues
1. Check Railway metrics (CPU/Memory)
2. Review slow queries in logs
3. Verify database indexes: `\di` in psql
4. Check rate limiting logs

---

## Scaling

Railway автоматически масштабирует:
- Horizontal: Несколько instances (Pro plan)
- Vertical: Больше CPU/Memory по требованию

Настройки в `railway.json` (optional):
```json
{
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "uvicorn app.main:app --host 0.0.0.0 --port $PORT",
    "healthcheckPath": "/health/ready",
    "healthcheckTimeout": 100,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

---

## Cost Optimization

### Free Tier ($0/month)
- 500 часов/месяц
- $5 credit monthly
- PostgreSQL included

### Pro Plan ($20/month)
- Unlimited hours
- Priority support
- Custom domains
- Team collaboration

**Рекомендация для MVP:** Начните с Free Tier, переходите на Pro при >1000 active users.

---

## Next Steps

После успешного deployment:

1. [ ] Тестируйте production endpoint
2. [ ] Настройте Telegram Mini App на production URL
3. [ ] Мониторьте логи первые 24 часа
4. [ ] Настройте alerts (Sentry/Railway notifications)
5. [ ] Document production URL для команды
